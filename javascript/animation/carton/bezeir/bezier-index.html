<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>bezier by 李可</title>

</head>

<body>
    <canvas id="canvas" width="1000" height="600"></canvas>
    <br>
    <input type="button" id="btn1" value="绘制">
    <input type="button" id="btn2" value="清空">
    <script src="bezier.js"></script>
    <script>
        const controlPoints = []//{ x: 100, y: 500 }, { x: 150, y: 400 }, { x: 600, y: 300 }, { x: 400, y: 150 }

        const pen = canvas.getContext('2d')
        function init(pen) {
            pen.fillStyle = "#444"
            pen.fillRect(0, 0, canvas.width, canvas.height)
        }
        init(pen)

        canvas.onmousedown = function (e) {
            const point = { x: e.offsetX, y: e.offsetY }
            controlPoints.push(point)
            drawText(point, controlPoints.length)
            drawNode(point)
            drawLastLine(controlPoints)
        }
        //显示点击位置
        function drawText(point, inx, y = 10, font = 16) {
            pen.fillStyle = "#fff"
            pen.textAlign = 'end'
            pen.textBaseline = 'hanging'
            pen.font = `${font}px`//times
            //const colCount = Math.ceil((inx * font + y) / canvas.height)//- 80 * (colCount-1)
            pen.fillText(`${point.x}x${point.y}：${inx}`, 1000 - 20, inx === 1 ? y : (inx - 1) * font + y)

        }
        function drawNode({ x, y, borderColor = '#fff' }) {
            //画节点
            pen.beginPath()
            pen.strokeStyle = borderColor
            pen.arc(x, y, 10, 0, 2 * Math.PI)
            pen.stroke()
        }
        function drawLastLine(points) {
            //画最后两点连线 -折线
            var count = points.length
            if (count >= 2) {
                pen.beginPath()
                pen.strokeStyle = "white"
                pen.moveTo(points[count - 2].x, points[count - 2].y)
                pen.lineTo(points[count - 1].x, points[count - 1].y)
                pen.stroke()
            }
        }

        const pointCount = 100
        const step = 1 / pointCount//t->step++[0,1]
        //绘bezier曲线
        function drawBrokenLine(points, t = 1, color = 'white') {
            pen.beginPath()
            pen.moveTo(points[0].x, points[0].y)
            for (let { x, y } of points) {
                pen.strokeStyle = color
                pen.lineTo(x, y)
            }
            pen.stroke()
            return getPercentPoints(points, t)
        }

        function drawframe(points, t) {
            canvas.width = canvas.width
            init(pen)
            var percentPoints = drawBrokenLine(points, t)
            while (percentPoints.length > 1) {
                percentPoints = drawBrokenLine(percentPoints, t)
            }
            const bezeirPoints = getBezierPoints(controlPoints, step, t)
            drawBrokenLine(bezeirPoints, t, 'red')
        }
        btn1.onclick = function () {
            var t = 0
            // var timer = setInterval(() => {
            //     if (t <= 1) {
            //         drawframe(controlPoints, t)
            //         t += step
            //     } else {
            //         clearInterval(timer)
            //         drawframe(controlPoints, 1)
            //     }
            // }, 16.7)
            var timer = requestAnimationFrame(function frame() {
                if (t <= 1) {
                    drawframe(controlPoints, t)
                    t += step
                    requestAnimationFrame(frame)
                } else {
                    cancelAnimationFrame(timer)
                    drawframe(controlPoints, 1)
                }
            })
            // const bezeirPoints = getBezierPoints(controlPoints, step, 0.5)
            // drawBrokenLine(bezeirPoints, 1, 'red')
        }
        btn2.onclick = function () {
            controlPoints.splice(0, controlPoints.length)
            canvas.width = canvas.width
            init(pen)
            // pen.clearRect(0, 0, canvas.width, canvas.height)
        }
        function getRandomColor() {
            var arr = Array.from('0123456789abcdef')
            var color = "#"
            for (let i = 0; i < 6; i++) {
                color += arr[Math.floor(16 * Math.random())]
            }
            return color
        }
    </script>
</body>

</html>